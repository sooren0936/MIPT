# Суть асинхронного взаимодействия

В прошлых лекциях мы разбирали синхронное взаимодействие на примере протокола HTTP. Теперь рассмотрим
асинхронное взаимодействие. Посмотрите на схему ниже:

![async communication](img/async-communication-example.png)

Для асинхронного взаимодействия чаще всего используется промежуточный элемент – брокер сообщений.

> Брокер сообщений – это отдельный компонент в системе, как база данных или сервис.

`Producer` – это тот, кто отправляет сообщение. А `consumer` тот, кто читает. В данном
случае, `API-Service` является producer'ом, а `Report-Service` – consumer'ом.

> В зависимости от контекста сервис может быть и producer'ом, и consumer'ом одновременно.
> Например, `API-Service` отправляет сообщения, и поэтому он producer.
> Но в то же самое время `API-Service` может читать сообщения от другого сервиса и являться
> consumer'ом.

На первый взгляд может показаться, что между брокером и простым HTTP нет разницы. В обоих случаях мы
доставляем сообщения из точки А в точку B. Но есть принципиальные отличия:

1. Producer и consumer не знаю друг о друге. Они общаются не напрямую, а через брокер. Задача
   producer'а – отправить сообщение в брокер. А consumer'а – прочитать его.
2. Даже если consumer отсутствует, producer все равно сможет отправить сообщение, потому что их
   хранит в себе брокер. Точно так же и consumer может подписаться на получение новых сообщений,
   даже если producer'а нет (просто тогда новых сообщений не будет).
3. Producer не ждет обработки запроса от consumer'а. Он ожидает лишь того факта, что брокер сохранил у
   себя сообщение.

Последний пункт является самым важным. HTTP работает так:

1. Клиент отправляет запрос.
2. Сервер получает его.
3. Пока сервер выполняет операцию, клиент ждет его ответа.

В случае брокера же все по-другому:

1. Producer отправляет сообщение в брокер.
2. Брокер сохраняет у себя сообщение.
3. Producer ждет ответа от брокера, что сообщение принято, и приступает к следующей операции.

Producer'у не важно, получил ли сообщение consumer или нет. Его волнует лишь факт того, что брокер
сохранил сообщения у себя.

С одной стороны, такой подход несколько сложнее в понимании, потому что теперь мы напрямую не получаем от
сервера (consumer'а) ответ, что операцию он завершил (как в HTTP). С другой же стороны, это
решение подходит намного лучше для долгих операций.

## Долгие операции в асинхронном взаимодействии

Представьте себе, что есть `report-service`, который формирует годовой отчет. Но сама операция
занимает 3 минуты.
Если мы будем обращаться к сервису по HTTP, то вынуждены будем ждать несколько минут без возможности
приступить к следующей операции.
Использование брокеров же позволяет переиграть эту концепцию:

1. Producer отправляет запрос в брокер на формирование годового отчета.
2. `report-service` consume'ит сообщение из брокера и запускает логику формирования отчета.
3. Когда операция завершена, `report-service` produce'ит сообщение в брокер, что отчет готов.
4. Теперь другой сервис (или тот же producer) из первого пункта может подписаться на сообщения о
   готовности отчета из брокера.

Подобное разделение избавляет нас от необходимости ждать, пока операция будет выполнена здесь и
сейчас. Вместо этого мы создаем запрос на ее выполнение и в фоне ждем получения результатов.

Чтобы стало еще понятнее, давайте рассмотрим примеры из реальной жизни.

**Синхронное взаимодействие:**

1. Ожидание в очереди в супермаркете, пока кассир сможет пробить вашу покупку.
2. Прямое обращение в отделение банка: ждете в окне, пока оператор за стойкой решит ваш вопрос.

**Асинхронное взаимодействие:**

1. Формирование заказа продуктов через Интернет. Курьер принесет их вам сам, когда все будет
   готово.
2. Отправка запроса в службу поддержки банка. Специалист ответит вам в течение 2-х рабочих дней.

## Что лучше?

Нельзя сказать однозначно, что асинхронное взаимодействие лучше синхронного или наоборот. Мы можем
дать вам такие рекомендации для принятия решения:

**Признаки того, что стоит выбрать синхронное взаимодействие:**

1. Операция выполняется быстро (до 1 секунды).
2. Результат нужен здесь и сейчас. Отложить его нельзя, потому что без него нельзя продолжить
   дальнейшую работу.
3. Снижение доступности является приемлемым (если сервер упадет, клиент без его ответа тоже не
   сможет работать корректно).

**Признаки того, что выбрать асинхронное взаимодействие:**

1. Операция выполняется долго (1 минуту и более):
2. Получение результата можно отложить (например, отправить его клиенту на почту через несколько
   минут). Нет необходимости ждать его сейчас.
3. Снижение доступности неприемлемо: если consumer упал, producer все равно должен продолжить
   работу (сообщение в брокер попадет, но consumer прочитает его позже).