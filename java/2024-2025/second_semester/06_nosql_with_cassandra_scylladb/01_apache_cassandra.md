### Архитектура Apache Cassandra

#### Введение

Apache Cassandra — это распределенная NoSQL-база данных, разработанная для обработки больших объемов данных с высокой доступностью, масштабируемостью и отказоустойчивостью. 

Рассмотрим архитектуру Cassandra, включая ее ключевые компоненты, принципы работы и особенности, которые делают ее одной из самых популярных баз данных для работы с Big Data.

---

### 1. Основные принципы архитектуры Cassandra

Cassandra построена на основе нескольких ключевых принципов, которые определяют ее архитектуру:

1. **Распределенность**: Данные распределяются по множеству узлов в кластере.
2. **Отказоустойчивость**: Cassandra обеспечивает высокую доступность данных даже при выходе из строя части узлов.
3. **Линейная масштабируемость**: Добавление новых узлов в кластер увеличивает его производительность и емкость.
4. **Отсутствие единой точки отказа**: Cassandra не имеет централизованного компонента, что делает ее устойчивой к сбоям.

---

### 2. Компоненты архитектуры Cassandra

#### 2.1. Узлы (Nodes)

**Узел** — это отдельный сервер, на котором работает экземпляр Cassandra. Каждый узел отвечает за хранение части данных и выполнение запросов.

- **Равноправность узлов**: Все узлы в кластере Cassandra равноправны. Нет главного или подчиненного узла.
- **Автоматическое распределение данных**: Данные автоматически распределяются между узлами с использованием хэш-функции.

#### 2.2. Кластер (Cluster)

**Кластер** — это набор узлов, которые работают вместе для хранения и обработки данных. Кластер может состоять из одного или нескольких дата-центров.

- **Дата-центры (Data Centers)**: Группы узлов, которые физически расположены в одном месте.
- **Стратегии репликации**: Определяют, как данные реплицируются между узлами и дата-центрами.

#### 2.3. Кольцо (Ring)

Cassandra использует **кольцевую архитектуру** для распределения данных. Каждый узел в кластере отвечает за определенный диапазон данных, который определяется с помощью хэш-функции.

- **Токены (Tokens)**: Каждому узлу назначается токен, который определяет его позицию в кольце.
- **Consistent Hashing**: Данные распределяются по узлам с использованием алгоритма consistent hashing, что позволяет минимизировать перемещение данных при добавлении или удалении узлов.

#### 2.4. Репликация (Replication)

Cassandra обеспечивает отказоустойчивость за счет репликации данных. Каждый фрагмент данных хранится на нескольких узлах.

- **Фактор репликации (Replication Factor)**: Количество копий данных, которые хранятся в кластере.
- **Стратегии репликации**:
    - **SimpleStrategy**: Для одного дата-центра. Подходит только для тестов и локального развертывания
    - **NetworkTopologyStrategy**: Используется для нескольких дата-центров для production system.

#### 2.5. Согласованность (Consistency)

Cassandra использует модель **настраиваемой согласованности** (Tunable Consistency), которая позволяет балансировать между доступностью и согласованностью данных.

- **Примеры уровней согласованности**:
    - **ONE**: Запрос считается успешным, если хотя бы одна реплика подтвердила операцию.
    - **QUORUM**: Запрос считается успешным, если большинство реплик подтвердили операцию.
    - **ALL**: Запрос считается успешным, если все реплики подтвердили операцию.

#### 2.6. Gossip Protocol

Cassandra использует **Gossip Protocol** для обмена информацией между узлами. Этот протокол позволяет узлам узнавать о состоянии других узлов в кластере.

- **Обмен сообщениями**: Узлы периодически обмениваются сообщениями о своем состоянии и состоянии других узлов.
- **Обнаружение сбоев**: Если узел не отвечает, другие узлы узнают об этом через Gossip Protocol.

#### 2.7. Механизм записи (Write Path)

Cassandra оптимизирована для записи данных. Процесс записи включает следующие шаги:

1. **Запись в CommitLog**: Данные сначала записываются в CommitLog для обеспечения долговечности.
2. **Запись в MemTable**: Данные затем записываются в MemTable, которая находится в оперативной памяти.
3. **Запись в SSTable**: Когда MemTable достигает определенного размера, данные записываются на диск в виде SSTable (Sorted String Table).

#### 2.8. Механизм чтения (Read Path)

Процесс чтения данных в Cassandra включает следующие шаги:

1. **Чтение из MemTable**: Cassandra сначала проверяет данные в MemTable.
2. **Чтение из SSTable**: Если данные не найдены в MemTable, Cassandra ищет их в SSTable.
3. **Слияние данных**: Если данные находятся в нескольких SSTable, Cassandra объединяет их и возвращает клиенту.

#### 2.9. Компактизация (Compaction)

Cassandra периодически выполняет компактизацию SSTable для удаления устаревших данных и уменьшения их количества.

- **Типы компактизации**:
    - **Size-Tiered Compaction**: Является компакшеном по умолчанию. Объединяет SSTable схожего размера. Подходит для большинства систем, но требователен к ресурсам
    - **Leveled Compaction**: Организует SSTable в уровни для более эффективного чтения. Применимость у него небольшая.
    - **Time-Window Compaction**: Организует SSTable в уровни для более эффективного чтения. Используется для time-series данных. Имеет очень строгие ограничения по использованию.

---

### 3. Пример работы кластера Cassandra

Рассмотрим пример работы кластера Cassandra с тремя узлами:

1. **Добавление данных**:
    - Клиент отправляет запрос на запись данных на один из узлов.
    - Узел вычисляет хэш-значение ключа и определяет, на каких узлах должны храниться данные.
    - Данные записываются на соответствующие узлы и реплицируются в соответствии с фактором репликации.

2. **Чтение данных**:
    - Клиент отправляет запрос на чтение данных на один из узлов.
    - Узел определяет, на каких узлах находятся данные, и запрашивает их.
    - Данные возвращаются клиенту с учетом уровня согласованности.

---

### 4. Преимущества архитектуры Cassandra

1. **Высокая доступность**: Отсутствие единой точки отказа и репликация данных обеспечивают высокую доступность.
2. **Линейная масштабируемость**: Добавление новых узлов увеличивает производительность и емкость кластера.
3. **Отказоустойчивость**: Данные реплицируются на несколько узлов, что обеспечивает отказоустойчивость.
4. **Гибкость**: Поддержка различных уровней согласованности и стратегий репликации.
